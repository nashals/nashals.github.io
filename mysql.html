<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head><!-- <meta name="baidu-site-verification" content="707024a76f8f40b549f07f478abab237"/> -->
<title>mysql</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="mysql"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2014-01-30T14:09+0800"/>
<meta name="author" content="dirtysalt"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style><link rel="shortcut icon" href="css/favicon.ico" /> <link rel="stylesheet" type="text/css" href="css/site.css" />


</head>
<body><!-- <div id="bdshare" class="bdshare_t bds_tools_32 get-codes-bdshare"><a class="bds_tsina"></a><span class="bds_more"></span><a class="shareCount"></a></div> --><!-- Place this tag where you want the +1 button to render --><!-- <g:plusone annotation="inline"></g:plusone> -->

<div id="preamble">

</div>

<div id="content">
<h1 class="title">mysql</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="mysql.html#sec-1">1 mysql</a>
<ul>
<li><a href="mysql.html#sec-1-1">1.1 数据类型</a></li>
<li><a href="mysql.html#sec-1-2">1.2 Index索引</a>
<ul>
<li><a href="mysql.html#sec-1-2-1">1.2.1 索引类型</a></li>
<li><a href="mysql.html#sec-1-2-2">1.2.2 索引特性</a></li>
<li><a href="mysql.html#sec-1-2-3">1.2.3 挑选索引</a></li>
</ul>
</li>
<li><a href="mysql.html#sec-1-3">1.3 存储引擎</a>
<ul>
<li><a href="mysql.html#sec-1-3-1">1.3.1 MyISAM</a></li>
<li><a href="mysql.html#sec-1-3-2">1.3.2 InnoDB</a></li>
</ul>
</li>
<li><a href="mysql.html#sec-1-4">1.4 事务处理</a>
<ul>
<li><a href="mysql.html#sec-1-4-1">1.4.1 ACID</a></li>
<li><a href="mysql.html#sec-1-4-2">1.4.2 隔离性</a></li>
</ul>
</li>
<li><a href="mysql.html#sec-1-5">1.5 外键和引用完整性</a></li>
<li><a href="mysql.html#sec-1-6">1.6 存储过程</a></li>
<li><a href="mysql.html#sec-1-7">1.7 元数据</a>
<ul>
<li><a href="mysql.html#sec-1-7-1">1.7.1 SHOW</a></li>
<li><a href="mysql.html#sec-1-7-2">1.7.2 information_schema</a></li>
<li><a href="mysql.html#sec-1-7-3">1.7.3 mysql</a></li>
</ul>
</li>
<li><a href="mysql.html#sec-1-8">1.8 数据目录</a>
<ul>
<li><a href="mysql.html#sec-1-8-1">1.8.1 目录位置</a></li>
<li><a href="mysql.html#sec-1-8-2">1.8.2 层次结构</a></li>
</ul>
</li>
<li><a href="mysql.html#sec-1-9">1.9 权限管理</a></li>
<li><a href="mysql.html#sec-1-10">1.10 查询优化</a>
<ul>
<li><a href="mysql.html#sec-1-10-1">1.10.1 层级估算</a></li>
<li><a href="mysql.html#sec-1-10-2">1.10.2 优化索引</a></li>
<li><a href="mysql.html#sec-1-10-3">1.10.3 EXPLAIN</a></li>
<li><a href="mysql.html#sec-1-10-4">1.10.4 查询缓存</a></li>
</ul>
</li>
<li><a href="mysql.html#sec-1-11">1.11 备份复制</a>
<ul>
<li><a href="mysql.html#sec-1-11-1">1.11.1 检查修复</a></li>
<li><a href="mysql.html#sec-1-11-2">1.11.2 数据备份</a></li>
<li><a href="mysql.html#sec-1-11-3">1.11.3 主从同步</a></li>
</ul>
</li>
<li><a href="mysql.html#sec-1-12">1.12 配置文件</a></li>
<li><a href="mysql.html#sec-1-13">1.13 系统变量</a>
<ul>
<li><a href="mysql.html#sec-1-13-1">1.13.1 日志相关</a></li>
<li><a href="mysql.html#sec-1-13-2">1.13.2 系统相关</a></li>
<li><a href="mysql.html#sec-1-13-3">1.13.3 存储引擎</a></li>
</ul>
</li>
<li><a href="mysql.html#sec-1-14">1.14 编程接口</a>
<ul>
<li><a href="mysql.html#sec-1-14-1">1.14.1 超时重连</a></li>
<li><a href="mysql.html#sec-1-14-2">1.14.2 连接数量</a></li>
</ul>
</li>
<li><a href="mysql.html#sec-1-15">1.15 实用程序</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> mysql</h2>
<div class="outline-text-2" id="text-1">

<ul>
<li><a href="http://www.mysql.com/">http://www.mysql.com/</a>
</li>
<li>MySQL技术内幕
</li>
</ul>



</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> 数据类型</h3>
<div class="outline-text-3" id="text-1-1">

<p>TODO（dirlt）：
</p></div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Index索引</h3>
<div class="outline-text-3" id="text-1-2">


</div>

<div id="outline-container-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> 索引类型</h4>
<div class="outline-text-4" id="text-1-2-1">

<ul>
<li>唯一索引 PRIMARY KEY &amp; UNIQUE
<ul>
<li>PRIMARY KEY必须是NOT NULL属性，而UNIQUE不需要
</li>
<li>每个数据表只能有一个PRIMARY KEY
</li>
</ul>

</li>
<li>普通（非唯一）索引 INDEX
</li>
<li>FULLTEXT索引（只适用于MyISAM引擎）
</li>
<li>SPATIAL索引（必须NOT NULL属性）     
</li>
</ul>


</div>

</div>

<div id="outline-container-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><span class="section-number-4">1.2.2</span> 索引特性</h4>
<div class="outline-text-4" id="text-1-2-2">

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">索引特性</th><th scope="col" class="left">MyISAM</th><th scope="col" class="left">InnoDB</th></tr>
</thead>
<tbody>
<tr><td class="left">是否允许使用NULL</td><td class="left">Y</td><td class="left">Y</td></tr>
<tr><td class="left">每个索引最多支持多少数据列</td><td class="left">16</td><td class="left">16</td></tr>
<tr><td class="left">每个数据表最多多少个索引</td><td class="left">64</td><td class="left">64</td></tr>
<tr><td class="left">索引项的最大长度（字节）</td><td class="left">1000</td><td class="left">1024/3072</td></tr>
<tr><td class="left">能否为数据列前缀创建索引</td><td class="left">Y</td><td class="left">Y</td></tr>
<tr><td class="left">数据列前缀的最大长度（字节）</td><td class="left">1000</td><td class="left">767</td></tr>
<tr><td class="left">是否支持BLOB/TEXT索引</td><td class="left">Y</td><td class="left">Y</td></tr>
<tr><td class="left">是否支持FULLTEXT索引</td><td class="left">Y</td><td class="left">N</td></tr>
<tr><td class="left">是否支持SPATIAL索引</td><td class="left">Y</td><td class="left">N</td></tr>
<tr><td class="left">索引和数据是否分离</td><td class="left">N</td><td class="left">Y</td></tr>
</tbody>
</table>


<p>
索引加快了检索速度，但是却降低了在带索引的数据列里插入删除以及修改的速度，因为不仅需要维护数据还需要维护索引。另外索引要占据磁盘空间。所以如果不需要某个特定的索引来加快查询速度，就不要创建它。
</p>
</div>

</div>

<div id="outline-container-1-2-3" class="outline-4">
<h4 id="sec-1-2-3"><span class="section-number-4">1.2.3</span> 挑选索引</h4>
<div class="outline-text-4" id="text-1-2-3">

<ul>
<li>尽量为用来搜索，分类或分组的数据列编制索引，不要为作为输出显示的数据列编制索引。
</li>
<li>综合考虑各数据列的维度势。尽可能选择数值差异比较大也就是维度比较高的数据列来做索引。
</li>
<li>对短小的值进行索引。
</li>
<li>为字符串值的前缀编索引。（使用字符串最左边的n个字符来做索引）
<ul>
<li>如果数据列在前缀长度范围内具有足够的独一无二性，查询性能通常不会受到影响，而是会得到改善。
</li>
<li>为数据列前缀而不是整个数据列编索引可以让索引本身更小并加快访问速度。
</li>
</ul>

</li>
<li>充分利用最左边的前缀。MySQL不能使用没有包含最左边前缀的搜索的索引。
</li>
<li>适可而止，不要建立过多的索引。
</li>
<li>让索引的类型与你打算进行的比较操作的类型保持匹配。
<ul>
<li>InnoDB总是使用BTree索引
</li>
<li>MyISAM也使用BTree索引，但是遇到空间数据类型会改用RTree索引
</li>
<li>MEMORY默认使用Hash索引，但是也支持BTree索引
</li>
</ul>

</li>
<li>利用“慢查询”日志找出性能低劣的查询。
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> 存储引擎</h3>
<div class="outline-text-3" id="text-1-3">

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">存储引擎</th><th scope="col" class="left">存储文件</th></tr>
</thead>
<tbody>
<tr><td class="left">ARCHIVE 用于数据存档的引擎（数据行被插入之后就不能再修改）</td><td class="left">.ARZ 数据文件, .ARM 元数据文件</td></tr>
<tr><td class="left">BLACKHOLE 写操作是删除数据，读操作是返回空白记录</td><td class="left">不存储任何数据</td></tr>
<tr><td class="left">CSV 存储数据时候以逗号为数据项之间的分隔符</td><td class="left">.CSV 数据文件,  .CSM 元数据文件</td></tr>
<tr><td class="left">EXAMPLE 示例（存根）存储引擎</td><td class="left">不存储任何数据</td></tr>
<tr><td class="left">Falcon 用来事务处理的存储引擎</td><td class="left">类似InnoDB</td></tr>
<tr><td class="left">FEDERATED 用来访问远程数据表的存储引擎</td><td class="left">不存储任何数据</td></tr>
<tr><td class="left">InnoDB 具备外键支持功能的事务处理引擎</td><td class="left"></td></tr>
<tr><td class="left">MEMORY 内存里的数据表</td><td class="left">数据存放在内存，不占用任何磁盘空间</td></tr>
<tr><td class="left">MERGE 用来管理多个MyISAM数据表构成的数据表集合</td><td class="left">.MRG 由各个成员MyISAM数据表的名字构成的清单</td></tr>
<tr><td class="left">MyISAM 默认的存储引擎(indexed sequential access method)</td><td class="left">.MYD 数据文件, .MYI 索引文件</td></tr>
<tr><td class="left">NDB MySQL Cluster的专用存储引擎</td><td class="left"></td></tr>
</tbody>
</table>


<p>
<b>NOTE（dirlt）：better focus on MyISAM and InnoDB only</b>
</p>
<p>
CREATE TABLE table(&hellip;) ENGINE = InnoDB/MyISAM optionA = &hellip; optionB = &hellip;; # 创建表格时指定存储引擎
</p>

</div>

<div id="outline-container-1-3-1" class="outline-4">
<h4 id="sec-1-3-1"><span class="section-number-4">1.3.1</span> MyISAM</h4>
<div class="outline-text-4" id="text-1-3-1">

<ul>
<li>MySQL默认使用的存储引擎
</li>
<li>通过FULLTEXT索引支持全文检索
</li>
<li>支持空间数据类型和SPATIAL索引
</li>
<li>数据组织
<ul>
<li>每个数据表对应一个数据文件和索引文件
</li>
<li>数据文件.MYD和索引文件.MYI分开存放
</li>
</ul>

</li>
<li>并发控制
<ul>
<li>使用了数据表级别的锁定机制来保证不同的客户不能同时修改同一数据表
</li>
<li>在更新量比较大的系统上会导致并发性能的下降
</li>
</ul>

</li>
</ul>


</div>

</div>

<div id="outline-container-1-3-2" class="outline-4">
<h4 id="sec-1-3-2"><span class="section-number-4">1.3.2</span> InnoDB</h4>
<div class="outline-text-4" id="text-1-3-2">

<ul>
<li>最早是由Innobase Oy公司开发，后来被Oracle收购
</li>
<li>支持事务（提交和回滚）操作，还可以通过创建保存点（savepoint）来实现部分回滚（partial rollback）
</li>
<li>系统崩溃之后可以自动恢复（相比MyISAM更透明）
</li>
<li>外键和引用完整性支持，包括递归删除和更新
</li>
<li>数据行级别的锁定和多版本共存，同时进行检索和更新操作的复杂查询里面有非常更好的并发性能（相比MyISAM的数据表级别锁定）
</li>
<li>数据组织
<ul>
<li>默认情况下InnoDB会把所有数据表存储在一个共享表空间里面，而不是像MyISAM引擎每个数据表创建单独文件
</li>
<li>表空间用类似一个虚拟文件系统方式来管理所有InnoDB数据表内容，可以由多个文件构成还可以包括原始分区，数据表的大小可以不受系统对文件最大长度的限制 <b>NOTE(dirlt):InnoDB支持原始分区！</b>
</li>
<li>允许每个数据表对应一个.ibd数据文件，但是使用这种方式数据表大小会受到文件最大长度的限制
</li>
<li><b>NOTE（dirlt）：即使分开存放，共享表空间还是会存放一些共享数据。因为最好不要通过操作文件系统方式来操作InnoDB数据表</b>
</li>
<li>但是无论使用上面两种方式的哪一种，InnoDB都是将数据和索引内容一起组织和存放的
</li>
</ul>

</li>
<li>并发控制
<ul>
<li>使用了数据行级别的锁定机制，为客户对数据表的访问提供了更加细致的控制
</li>
<li>在某个客户修改某个数据行的同时，另外一个客户可以都去和修改同一数据表里面的另外一数据行
</li>
<li>如果有两个客户想同时修改某个数据行，先锁定该数据行的客户可以先修改它
</li>
<li>比数据表级别的锁定机制提供了更好的并发性能
</li>
<li>至于一个客户的事务在何时才能看到另外一个客户的事务做出的修改，属于事务隔离性方面的问题
</li>
</ul>

</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> 事务处理</h3>
<div class="outline-text-3" id="text-1-4">


</div>

<div id="outline-container-1-4-1" class="outline-4">
<h4 id="sec-1-4-1"><span class="section-number-4">1.4.1</span> ACID</h4>
<div class="outline-text-4" id="text-1-4-1">

<p>事务机制的特性通常被概括为ACID，Atomic，Consistent，Isolated，Durable，他们分别代表事务机制应该具备的一个属性。
</p><ul>
<li>Atomic 构成一个事务的所有语句应该是一个独立的逻辑单元，要么全部执行成功，要么一个都不成功，不能只执行他们当中的一部分。
</li>
<li>Consistent 数据库在事务开始执行之前和事务执行完毕之后都必须是稳定的。
</li>
<li>Isolated 事务不应该相互影响。
</li>
<li>Durable 如果事务执行成功，它的影响将被永久性地记录到数据库里。
</li>
</ul>


</div>

</div>

<div id="outline-container-1-4-2" class="outline-4">
<h4 id="sec-1-4-2"><span class="section-number-4">1.4.2</span> 隔离性</h4>
<div class="outline-text-4" id="text-1-4-2">

<p>InnoDB存储引擎实现的事务隔离级别机制能够让客户控制他们想看到其他事务做的修改。它提供了多种不同的隔离级别以允许或预防在多个事务同时运行时可能发生的各种各样的问题：
</p><ul>
<li>脏读（dirty read） 某个事务所作的修改在它尚未被提交时就可以被其他事务看到。
</li>
<li>不可重复读取（nonrepeatable read） 同一个事务使用同一条select语句每次读取到的结果不一样。
</li>
<li>幻影数据行（phantom row） 某个事务突然看到一个它以前没有见过的数据行。
</li>
</ul>

<p>为了解决这些问题，InnoDB存储引擎提供了4种隔离级别。这些隔离级别用来确定允许某个事务看到与之同时执行的其他事务所做出的修改：（级别不断提高）
</p><ul>
<li>READ UNCOMMITED 允许事务看到其他事务尚未提交的数据行改动
</li>
<li>READ COMMITED 只允许事务看到其他事务已经提交的数据行改动
</li>
<li>REPEATABLE READ 如果某个事务两次执行同一个select语句，其结果是可重复的。也就是说如果两次期间如果有数据修改的话，修改是隔离的。InnoDB默认的事务隔离级别。
</li>
<li>SERIALIZABLE 这个隔离级别与REPEATABLE READ很相似，但对事务的隔离更加彻底，某个事务正在查看的数据行不允许其他事务修改，直到该事务完成为止。
</li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">隔离级别</th><th scope="col" class="left">脏读</th><th scope="col" class="left">不可重复读取</th><th scope="col" class="left">幻影数据行</th></tr>
</thead>
<tbody>
<tr><td class="left">READ UNCOMMITED</td><td class="left">Y</td><td class="left">Y</td><td class="left">Y</td></tr>
<tr><td class="left">READ COMMITED</td><td class="left">N</td><td class="left">Y</td><td class="left">Y</td></tr>
<tr><td class="left">REPEATABLE READ</td><td class="left">N</td><td class="left">N</td><td class="left">N</td></tr>
<tr><td class="left">SERIALIZABLE</td><td class="left">N</td><td class="left">N</td><td class="left">N</td></tr>
</tbody>
</table>


</div>
</div>

</div>

<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> 外键和引用完整性</h3>
<div class="outline-text-3" id="text-1-5">

</div>

</div>

<div id="outline-container-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> 存储过程</h3>
<div class="outline-text-3" id="text-1-6">

</div>

</div>

<div id="outline-container-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> 元数据</h3>
<div class="outline-text-3" id="text-1-7">


</div>

<div id="outline-container-1-7-1" class="outline-4">
<h4 id="sec-1-7-1"><span class="section-number-4">1.7.1</span> SHOW</h4>
<div class="outline-text-4" id="text-1-7-1">

<p>TODO(dirlt):
</p>
<ul>
<li>SHOW DATABASES;
</li>
<li>SHOW CREATE DATABASE db_name;
</li>
<li>SHOW TABLES [FROM db_name];
</li>
<li>SHOW CREATE TABLE tbl_name;
</li>
<li>SHOW COLUMNS FROM tbl_name;
</li>
<li>SHOW INDEX FROM tbl_name;
</li>
<li>SHOW TABLE STATUS [FROM db_name];
</li>
</ul>


</div>

</div>

<div id="outline-container-1-7-2" class="outline-4">
<h4 id="sec-1-7-2"><span class="section-number-4">1.7.2</span> information_schema</h4>
<div class="outline-text-4" id="text-1-7-2">

<p>可以将information_schema看作一个虚拟数据库，里面的数据表是不同数据库的元数据所构成的视图。各个存储引擎还会在这里面添加它们专用的数据表。
</p>



<pre class="example">mysql&gt; show tables in information_schema;
+---------------------------------------+
| Tables_in_information_schema          |
+---------------------------------------+
| CHARACTER_SETS                        |
| COLLATIONS                            |
| COLLATION_CHARACTER_SET_APPLICABILITY |
| COLUMNS                               |
| COLUMN_PRIVILEGES                     |
| ENGINES                               |
| EVENTS                                |
| FILES                                 |
| GLOBAL_STATUS                         |
| GLOBAL_VARIABLES                      |
| KEY_COLUMN_USAGE                      |
| PARAMETERS                            |
| PARTITIONS                            |
| PLUGINS                               |
| PROCESSLIST                           |
| PROFILING                             |
| REFERENTIAL_CONSTRAINTS               |
| ROUTINES                              |
| SCHEMATA                              |
| SCHEMA_PRIVILEGES                     |
| SESSION_STATUS                        |
| SESSION_VARIABLES                     |
| STATISTICS                            |
| TABLES                                |
| TABLESPACES                           |
| TABLE_CONSTRAINTS                     |
| TABLE_PRIVILEGES                      |
| TRIGGERS                              |
| USER_PRIVILEGES                       |
| VIEWS                                 |
| INNODB_BUFFER_PAGE                    |
| INNODB_TRX                            |
| INNODB_BUFFER_POOL_STATS              |
| INNODB_LOCK_WAITS                     |
| INNODB_CMPMEM                         |
| INNODB_CMP                            |
| INNODB_LOCKS                          |
| INNODB_CMPMEM_RESET                   |
| INNODB_CMP_RESET                      |
| INNODB_BUFFER_PAGE_LRU                |
+---------------------------------------+
</pre>


</div>

</div>

<div id="outline-container-1-7-3" class="outline-4">
<h4 id="sec-1-7-3"><span class="section-number-4">1.7.3</span> mysql</h4>
<div class="outline-text-4" id="text-1-7-3">

<p>TODO（dirlt）：
</p>



<pre class="example">mysql&gt; show tables in mysql;
+---------------------------+
| Tables_in_mysql           |
+---------------------------+
| columns_priv              |
| db                        |
| event                     |
| func                      |
| general_log               |
| help_category             |
| help_keyword              |
| help_relation             |
| help_topic                |
| host                      |
| ndb_binlog_index          |
| plugin                    |
| proc                      |
| procs_priv                |
| proxies_priv              |
| servers                   |
| slow_log                  |
| tables_priv               |
| time_zone                 |
| time_zone_leap_second     |
| time_zone_name            |
| time_zone_transition      |
| time_zone_transition_type |
| user                      |
+---------------------------+
</pre>


</div>
</div>

</div>

<div id="outline-container-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> 数据目录</h3>
<div class="outline-text-3" id="text-1-8">


</div>

<div id="outline-container-1-8-1" class="outline-4">
<h4 id="sec-1-8-1"><span class="section-number-4">1.8.1</span> 目录位置</h4>
<div class="outline-text-4" id="text-1-8-1">

<ul>
<li>源代码安装默认是 /usr/local/mysql/var
</li>
<li>包安装默认是 /var/lib/mysql
</li>
<li>configure选项 &ndash;localstatedir 可以修改默认位置
</li>
<li>datadir 选项可以指定位置
</li>
</ul>


</div>

</div>

<div id="outline-container-1-8-2" class="outline-4">
<h4 id="sec-1-8-2"><span class="section-number-4">1.8.2</span> 层次结构</h4>
<div class="outline-text-4" id="text-1-8-2">

<ul>
<li>每个数据库对应一个目录
<ul>
<li>.opt文件列出这个数据库默认使用的字符集和排序方式
</li>
<li>数据库内的数据表，视图和触发器对应于该数据库目录中的文件
</li>
<li>每个视图对应一个.frm文件，数据表也对应一个.frm文件
</li>
<li>和某个数据表tbl相关的触发器定义和相关信息，存储在tbl.trg文件里面
</li>
<li>同一个数据表可以有多个触发器，而服务器把他们的定义集中保存在同一个.trg文件里面
</li>
</ul>

</li>
<li>服务器进程ID文件。
<ul>
<li>HOSTNAME.pid
</li>
</ul>

</li>
<li>服务器生成状态和日志文件。
<ul>
<li>HOSTNAME.err 错误日志 
</li>
<li>HOSTNAME.log 一般查询日志 
</li>
<li>HOSTNAME-bin.nnnnnn 二进制文件（修改数据语句和内容）
</li>
<li>HOSTNAME-bin.index 二进制文件的索引文件
</li>
<li>HOSTNAME-relay-bin.nnnnnn  延迟日志
</li>
<li>HOSTNAME-relay-bin.index 延迟日志索引
</li>
<li>master.info 主服务器信息
</li>
<li>relay-log.info 延迟信息
</li>
<li>HOSTNAME-slow.log 慢查询日志
<ul>
<li>判断是否为慢查询和下面两个指标相关
</li>
<li>long_query_time（单位秒） # 判断多长时间为慢
</li>
<li>min_examined_row_limit # 只有被查询这么多次之后才有资格被记录到日志里面
</li>
</ul>

</li>
</ul>

</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-1-9" class="outline-3">
<h3 id="sec-1-9"><span class="section-number-3">1.9</span> 权限管理</h3>
<div class="outline-text-3" id="text-1-9">

<ul>
<li>GRANT ALL PRIVILEGES ON &lt;db&gt;(<b>).&lt;table&gt;(</b>) TO 'user'@'host' IDENTIFIED BY 'password' # 授权
</li>
<li>SET PASSWORD for 'user'@'host' = password('123456') # 重置密码
</li>
<li>FLUSH PRIVILEGES # 刷新权限表
</li>
</ul>


</div>

</div>

<div id="outline-container-1-10" class="outline-3">
<h3 id="sec-1-10"><span class="section-number-3">1.10</span> 查询优化</h3>
<div class="outline-text-3" id="text-1-10">


</div>

<div id="outline-container-1-10-1" class="outline-4">
<h4 id="sec-1-10-1"><span class="section-number-4">1.10.1</span> 层级估算</h4>
<div class="outline-text-4" id="text-1-10-1">

<ul>
<li><b>NOTE（dirlt）：thanks caole</b> 
</li>
<li><b>TODO（dirlt）：如何估算disk IOPS?</b>
</li>
</ul>


<p>
以innodb为例，每个page(注意这里是innodb的page,不是linux page)是16K. B+Tree的话那么每层都会存放key. 假设key为16个字节的话，包括overhead 16个字节，那么一个page里面就能够存放512个节点。如果记录界级别在billion级别的话，那么深度在3-4层左右。估算出层级数目是非常有好处的，可以对query做envelope calculation. 假设不考虑page cache的话，那么查询一条记录通常需要读取3-4次。假设存在cache命中50%的话，那么读取次数在1.5-2次。如果使用MySQL没有缓存层并且都是简单查询的话，要求查询性能在2w/s. 那么要求disk IOPS必须在3w-4w/s上。所以如果性能达不到这个要求的话，那么就需要考虑分表。 <b>NOTE（dirlt）：所以分表可能会是因为性能原因，也可能会是因为存储空间原因</b>
</p>
</div>

</div>

<div id="outline-container-1-10-2" class="outline-4">
<h4 id="sec-1-10-2"><span class="section-number-4">1.10.2</span> 优化索引</h4>
<div class="outline-text-4" id="text-1-10-2">

<ul>
<li>对数据表进行分析
<ul>
<li>生成关于索引值分布情况的统计数据，帮助优化器对索引的使用效果做出更准确的评估
</li>
<li>默认情况下当把有索引数据列与常数比较的时候，优化起会假设相关索引里的键值是均匀分布的，同时还会对索引进行一次快速检查以估算需要用到多少个索引项
</li>
<li>使用ANALYSE TABLE语句来进行分析，频率根据数据表变化频繁程度而定
</li>
</ul>

</li>
<li>对容易产生碎片的数据表进行整理，定期使用OPTIMIZE TABLE语句有助于防止数据表查询性能的降低
</li>
<li>使用EXPLAIN语句验证优化器操作 # 可以告诉查询计划，是否使用索引以及如何使用索引等
</li>
<li>提示优化器
<ul>
<li>FORCE INDEX, USE INDEX, IGNORE INDEX
</li>
<li>STRAIGHT_JOIN # 强制优化器按照特定顺序来做JOIN
</li>
</ul>

</li>
<li>尽量使用数据类型相同的数据列进行比较
</li>
<li>使带索引的数据列在比较表达式中单独出现 
<ul>
<li>f(x) &lt; 4, 这样就需要遍历所有x并且作用f然后比较。所以最好是可以x &lt; f^-1(4) <b>NOTE(dirlt):逆函数</b>
</li>
</ul>

</li>
<li>不要在LIKE模式的开始位置使用通配符
</li>
<li>试验各种查询的变化格式，并且需要多次运行它们
</li>
<li>避免过多使用MySQL的自动类型转换功能 <b>NOTE（dirlt）：隐式类型转换会可能会阻碍索引的使用</b>
</li>
</ul>


</div>

</div>

<div id="outline-container-1-10-3" class="outline-4">
<h4 id="sec-1-10-3"><span class="section-number-4">1.10.3</span> EXPLAIN</h4>
<div class="outline-text-4" id="text-1-10-3">

<p>EXPLAIN语句提供的信息可以帮助我们了解优化器为处理各种语句而生成的执行计划。这里以两个例子做说明。假设我们有t1,t2两个数据表，列分别为k(int)，v(int)，然后分别执行下面语句
</p><ol>
<li>SELECT * from t1 WHERE k &lt; 20 AND k &gt; 10
</li>
<li>SELECT * from t1 INNER JOIN t2 WHERE t1.k = t2.k
</li>
</ol>

<p>假设t1数据有1000条记录k=[1,50], 而t2数据有10条记录k=[1,10]
</p>



<pre class="example">#!/bin/bash
echo "DROP DATABASE test;"
echo "CREATE DATABASE test;"
echo "USE test";
echo "CREATE TABLE t1 (k INT NOT NULL, v INT);"
echo "CREATE TABLE t2 (k INT PRIMARY KEY, v INT);"
echo "use test";
for((i=1;i&lt;=50;i++))
do
    echo "INSERT INTO t1 VALUES($i,$i);"
done
for((i=1;i&lt;=10;i++))
do
    echo "INSERT INTO t2 VALUES($i,$i);"
done
</pre>


<p>
t1开始没有索引，然后我们使用EXAPLAIN来察看效果
</p>


<pre class="example">mysql&gt; explain SELECT * from t1 WHERE k &lt; 20 AND k &gt; 10;
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | t1    | ALL  | NULL          | NULL | NULL    | NULL |   50 | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
</pre>

<ul>
<li>select_type 简单选择 TODO（dirlt）：？？？
</li>
<li>table 数据表
</li>
<li>type 优化器可以用来搜索的区间（ALL表示只能全部扫描）
</li>
<li>possible_keys 可以用来做搜索的keys
</li>
<li>key/key_len 最终选择用来做搜索的key和其长度
</li>
<li>ref 是否参考其他数据表字段
</li>
<li>row 处理多少行数据
</li>
<li>Extra TODO（dirlt）：？？？
</li>
</ul>

<p>可以看到这个检索只能够使用全表扫描，下面来看看加上索引的效果
</p>



<pre class="example">mysql&gt; ALTER TABLE t1 ADD INDEX (k);
Query OK, 0 rows affected (0.18 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; explain SELECT * from t1 WHERE k &lt; 20 AND k &gt; 10;
+----+-------------+-------+-------+---------------+------+---------+------+------+-------------+
| id | select_type | table | type  | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+-------+-------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | t1    | range | k             | k    | 4       | NULL |    8 | Using where |
+----+-------------+-------+-------+---------------+------+---------+------+------+-------------+
</pre>

<ul>
<li>type=range 表明可以有范围查询
</li>
<li>possible_keys 可以使用k来做搜索
</li>
<li>key/key_len 最后也是使用k来做搜索，并且长度为4字节
</li>
<li>rows 只需要处理8个数据行
</li>
</ul>


<p>
为t1加上索引之后，然后看看语句2的效果
</p>


<pre class="example">mysql&gt; explain SELECT * from t1 INNER JOIN t2 WHERE t1.k = t2.k;
+----+-------------+-------+------+---------------+------+---------+-----------+------+-------+
| id | select_type | table | type | possible_keys | key  | key_len | ref       | rows | Extra |
+----+-------------+-------+------+---------------+------+---------+-----------+------+-------+
|  1 | SIMPLE      | t2    | ALL  | PRIMARY       | NULL | NULL    | NULL      |   10 |       |
|  1 | SIMPLE      | t1    | ref  | k             | k    | 4       | test.t2.k |    1 |       |
+----+-------------+-------+------+---------------+------+---------+-----------+------+-------+

</pre>

<p>
可以看到MySQL非常智能，并没有扫描t1然后在t2中查找，而是扫描t2在t1中查找。 <b>NOTE（dirlt）：这里这里type=ref以及ref字段内容</b>
</p>
</div>

</div>

<div id="outline-container-1-10-4" class="outline-4">
<h4 id="sec-1-10-4"><span class="section-number-4">1.10.4</span> 查询缓存</h4>
<div class="outline-text-4" id="text-1-10-4">

<p>如果数据很少更新的话，那么开启查询缓存是有利的。如果数据表被更新的话，所有与之相关的查询缓存都会失效并且被删除。
</p><ul>
<li>configure阶段 &ndash;without-query-cache 可以构建不带查询缓存的服务器
</li>
<li>have_query_cache 是否支持查询缓存
</li>
<li>query_cache_type
<ul>
<li>0 不使用查询缓存
</li>
<li>1 开启，但是不包括SELECT SQL_NO_CACHE开头的查询
</li>
<li>2 开启，但是只包括SELECT SQL_CACHE开头的查询
</li>
</ul>

</li>
<li>query_cache_size 查询缓存大小，字节为单位
</li>
<li>query_cache_limit 缓存最大结果集合大小，比这个值大的查询结果不能被缓存
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-1-11" class="outline-3">
<h3 id="sec-1-11"><span class="section-number-3">1.11</span> 备份复制</h3>
<div class="outline-text-3" id="text-1-11">


</div>

<div id="outline-container-1-11-1" class="outline-4">
<h4 id="sec-1-11-1"><span class="section-number-4">1.11.1</span> 检查修复</h4>
<div class="outline-text-4" id="text-1-11-1">

<ul>
<li>CHECK TABLE
</li>
<li>REPAIR TABLE
</li>
<li>mysqlcheck
</li>
</ul>


</div>

</div>

<div id="outline-container-1-11-2" class="outline-4">
<h4 id="sec-1-11-2"><span class="section-number-4">1.11.2</span> 数据备份</h4>
<div class="outline-text-4" id="text-1-11-2">

<p>数据库备份按照它们的格式可以分为两大类
</p><ul>
<li>文本格式备份，通过使用mysqldump程序把数据表内容输出成为SQL语句
</li>
<li>二进制备份，直接复制包含数据表内容的文件（不是特别推荐）
</li>
</ul>


<p>
有效加载数据基于下面几个基本原则
</p><ul>
<li>批量加载效率比单行加载的效率高 # 减少刷新频率和IO操作
</li>
<li>加载有索引的数据表比加载无索引的数据表慢 # 更新索引
</li>
<li>较短SQL语句比较长SQL语句快 # 更少的语法分析以及更少的传输量
</li>
</ul>


</div>

</div>

<div id="outline-container-1-11-3" class="outline-4">
<h4 id="sec-1-11-3"><span class="section-number-4">1.11.3</span> 主从同步</h4>
<div class="outline-text-4" id="text-1-11-3">

<p>mysql实现上是所有操作都会写到binlog里面，然后slave有一个专门的io线程(IO_THREAD)不断地从master binlog里面取出增量数据，写到本地的relay-log.同时slave本地有一个执行线程(SQL_THREAD)，将这些realy-log执行修改自己的数据库，达到同步的目的。relay-log里面的内容和master binlog内容每条记录都是完全相同的，最后进入slave binlog记录和master binlog对应记录也是一样的。执行id是master id,执行时间是master binlog记录的时间，本地slave是不会进行任何修改的。主从同步要求不仅要求主从服务器在二进制日志的格式方面兼容，还要在功能上兼容（执行对应的语句）
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">选项</th><th scope="col" class="left">内容</th></tr>
</thead>
<tbody>
<tr><td class="left">server-id</td><td class="left">服务器编号</td></tr>
<tr><td class="left">relay_log_purge</td><td class="left">删除无用的relaylog</td></tr>
<tr><td class="left">log-slave-updates</td><td class="left">binlog里面也会保存relay-log（默认是不保存）</td></tr>
<tr><td class="left">max_binlog_size</td><td class="left">单个binlog文件最大大小</td></tr>
<tr><td class="left">max_relay_log_size</td><td class="left">单个relaylog文件最大大小</td></tr>
<tr><td class="left">expire_logs_days=n</td><td class="left">自动删除超过n天的binlog，并且更新索引文件</td></tr>
<tr><td class="left">replicate-ignore-db</td><td class="left">slave忽略某些数据库的操作</td></tr>
<tr><td class="left">binlog-ignore-db</td><td class="left">master将某些数据库操作不写入binlog</td></tr>
<tr><td class="left">binlog-format</td><td class="left">binlog日志格式</td></tr>
</tbody>
</table>


<p>
binlog-format有三种选择
</p><ul>
<li>STATEMENT 基于语句，比较简短但是控制粒度不高
</li>
<li>ROW 基于数据行，比较冗余但是控制粒度好
</li>
<li>MIXED 混合。优先选择基于数据行，确有必要时候使用基于语句
</li>
</ul>


<p>
基本命令：
</p><ul>
<li>show binary logs; # 所有binlog
</li>
<li>show master logs; # 所有binlog
</li>
<li>show binlog events; # 察看binlog内容
</li>
<li>show master status; # 当前master进度
</li>
<li>reset master; # 清除所有binlog
</li>
<li>reset slave; # 清除所有relaylog
</li>
<li>start/stop slave # 启动停止复制
<ul>
<li>IO_THREAD 只启动停止IO线程
</li>
<li>SQL_THREAD 只启动停止SQL线程
</li>
</ul>

</li>
<li>purge master/binary logs to 'log-bin.000012'; # 将log-bin.000012之前的binlog都删除
</li>
<li>change master to master_host='', master_user='', master_password='', master_log_file='', master_log_pos='' # 初始化复制坐标
<ul>
<li>初始复制状态会记录在master.info文件，并且随着镜像工作进展而刷新这个文件
</li>
</ul>

</li>
</ul>


<p>
半同步(semi-sync)
</p><ul>
<li><a href="http://www.db110.com/?p=3364">http://www.db110.com/?p=3364</a>
</li>
<li><a href="http://code.google.com/p/google-mysql-tools/wiki/SemiSyncReplication">http://code.google.com/p/google-mysql-tools/wiki/SemiSyncReplication</a>
</li>
<li><a href="http://code.google.com/p/google-mysql-tools/wiki/SemiSyncReplicationDesign">http://code.google.com/p/google-mysql-tools/wiki/SemiSyncReplicationDesign</a>
</li>
<li><a href="http://dev.mysql.com/doc/refman/5.5/en/replication-semisync.html">http://dev.mysql.com/doc/refman/5.5/en/replication-semisync.html</a>
</li>
</ul>

<p>很早之前做了一个mysql集群主从切换模块，里面就涉及到了半同步。按照半同步的定义（全同步的语义应该就是等待所有的slave都同步完成，强一致性），半同步还是会存在丢数据的可能，半同步的语义仅仅是认为一个slave同步到数据之后的话同步就完成。但是如果master挂掉同时slave也挂掉（或者是没有等其他slave补齐数据的话），那么就会存在数据丢失的可能（仅仅是提供最终一致性可能）。
</p>
</div>
</div>

</div>

<div id="outline-container-1-12" class="outline-3">
<h3 id="sec-1-12"><span class="section-number-3">1.12</span> 配置文件</h3>
<div class="outline-text-3" id="text-1-12">

<ul>
<li>RPM安装包没有/etc/my.cnf，全部使用MySQL默认配置，/usr/share/mysql/my-default.cnf
</li>
<li>~/.my.cnf overrides /etc/my.cnf
<ul>
<li>[client] MySQL客户端程序选项组标记
</li>
<li>[mysqld] MySQL服务端程序选项组标记
</li>
<li>[mysqld-X.Y] MySQL服务端程序选项组标记，但是只有X.Y这个版本才会读取
</li>
<li>[mysqld&lt;nnnn&gt;] MySQL服务实例&lt;nnnn&gt;选项组标记，启动多实例时候有用
</li>
<li>[mysqld_multi] mysqld_multi程序选项组标记
</li>
</ul>

</li>
</ul>


</div>

</div>

<div id="outline-container-1-13" class="outline-3">
<h3 id="sec-1-13"><span class="section-number-3">1.13</span> 系统变量</h3>
<div class="outline-text-3" id="text-1-13">

<p>系统变量按照其作用范围的大小分为两个级别
</p><ul>
<li>全局级 # 全面影响整个服务器的操作，比如key_buffer_size控制MyISAM的索引数据缓冲区大小
</li>
<li>会话级 # 只印象服务器如何对待一个给定的客户链接，比如autocommit控制是否自动提交事务
</li>
</ul>

<p>可以通过下面两个命令来察看
</p><ul>
<li>SHOW VARIABLES # 优先会话级别
<ul>
<li>SHOW GLOBAl VARIABLES
</li>
<li>SHOW SESSION/LOCAL VARIABLES
</li>
</ul>

</li>
<li>mysqladmin variables # 全局级别
</li>
</ul>

<p>在SQL语句变量先使用会话级别，然后再使用全局级别，也可以显式指定
</p><ul>
<li>@@SESSION.var_name
</li>
<li>@@LOCAL.var_name
</li>
<li>@@GLOBAL.var_name
</li>
</ul>


<p>
MySQL服务器提供的状态变量使我们可以及时掌握它的实际运行状况。状态变量也分为全局和会话级别，可以通过下面命令察看
</p><ul>
<li>SHOW STATUS
</li>
<li>SHOW GLOBAL STATUS
</li>
<li>SHOW LOCAL/SESSION STATUS
</li>
</ul>



</div>

<div id="outline-container-1-13-1" class="outline-4">
<h4 id="sec-1-13-1"><span class="section-number-4">1.13.1</span> 日志相关</h4>
<div class="outline-text-4" id="text-1-13-1">

<p>刷新日志
</p><ul>
<li>FLUSH LOG &amp; mysqladmin flush-logs
</li>
<li>出错日志会关闭并且重命名为-old后缀文件，然后重新打开新文件写
</li>
<li>二进制和中继日志会关闭当前文件，然后打开下一个顺序编号的新文件
</li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">选项</th><th scope="col" class="left">内容</th></tr>
</thead>
<tbody>
<tr><td class="left">log-error[=filename]</td><td class="left"></td></tr>
<tr><td class="left">log=[filename]</td><td class="left"></td></tr>
<tr><td class="left">log-slow-queries=[filename]</td><td class="left"></td></tr>
<tr><td class="left">log-output[=destionation]</td><td class="left">常规/慢查询日志存放地点，FILE（文件，默认）/TABLE（数据表）/NONE</td></tr>
<tr><td class="left">log-bin[=flename]</td><td class="left"></td></tr>
<tr><td class="left">log-bin-index=filename</td><td class="left"></td></tr>
<tr><td class="left">log-relay[=filename]</td><td class="left"></td></tr>
<tr><td class="left">replay-log-index=filename</td><td class="left"></td></tr>
<tr><td class="left">log-short-format</td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="left">log-queries-not-using-indexes</td><td class="left">执行时没有使用索引的查询记录到慢查询日志</td></tr>
<tr><td class="left">log-slow-admin-statements</td><td class="left">执行较慢的系统管理语句记录到慢查询日志</td></tr>
</tbody>
</table>


</div>

</div>

<div id="outline-container-1-13-2" class="outline-4">
<h4 id="sec-1-13-2"><span class="section-number-4">1.13.2</span> 系统相关</h4>
<div class="outline-text-4" id="text-1-13-2">

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">选项</th><th scope="col" class="left">内容</th></tr>
</thead>
<tbody>
<tr><td class="left">basedir</td><td class="left">MySQL安装根目录</td></tr>
<tr><td class="left">datadir</td><td class="left">MySQL数据目录</td></tr>
<tr><td class="left">port</td><td class="left"></td></tr>
<tr><td class="left">socket</td><td class="left"></td></tr>
<tr><td class="left">pid-file</td><td class="left"></td></tr>
<tr><td class="left">max_allowed_packe</td><td class="left">通信使用的缓冲区最大长度</td></tr>
<tr><td class="left">max_connections</td><td class="left">同时处于打开状态的客户连接的最大个数</td></tr>
<tr><td class="left">table_cache/table_open_cache</td><td class="left">数据表文件句柄最大数</td></tr>
</tbody>
</table>


</div>

</div>

<div id="outline-container-1-13-3" class="outline-4">
<h4 id="sec-1-13-3"><span class="section-number-4">1.13.3</span> 存储引擎</h4>
<div class="outline-text-4" id="text-1-13-3">

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">选项</th><th scope="col" class="left">内容</th></tr>
</thead>
<tbody>
<tr><td class="left">default-storage-engine[=innodb]</td><td class="left">默认存储引擎</td></tr>
<tr><td class="left">innodb-file-per-table</td><td class="left">为每个数据表创建一个表空间</td></tr>
<tr><td class="left">innodb_data_home_dir</td><td class="left">数据目录（默认是MySQL数据目录）</td></tr>
<tr><td class="left">innodb_data_file_path</td><td class="left">数据文件列表</td></tr>
<tr><td class="left">innodb_autoextend_increment</td><td class="left">扩展表空间时递增量（8MB）</td></tr>
<tr><td class="left">innodb_buffer_pool_size</td><td class="left">数据和索引缓冲区大小</td></tr>
<tr><td class="left">innodb_log_buffer_size</td><td class="left">事务日志缓冲区</td></tr>
<tr><td class="left">innodb_log_group_home_dir</td><td class="left">事务日志文件(ib_)存放目录（默认是数据目录）</td></tr>
<tr><td class="left">innodb_log_file_size</td><td class="left">单个事务日志文件长度</td></tr>
<tr><td class="left">innodb_log_files_in_group</td><td class="left">事务日志文件数量（？？？）</td></tr>
</tbody>
</table>


<p>
innodb_data_file_path的格式这里需要详细解释，每个文件之间通过;分隔，每个文件规格说明如下
</p><ul>
<li>path:size # 文件初始大小size字节，并且不可扩展
</li>
<li>path:size:autoextend # 文件初始大小size字节，但是允许自动扩展 <b>NOTE（dirlt）：通常应该是留在最后的</b>
</li>
</ul>

<p>比如innodata1:50M;innodata2:100M;innodata3:200M:autoextend
</p>
<p>
InnoDB可以使用未经过格式化的硬盘分区，有几个理由值得考虑这么做：
</p><ul>
<li>不受文件系统控制
</li>
<li>保证整个存储空间连续性，减少存储空间碎片化
</li>
<li>减少文件系统管理层开销
</li>
</ul>

<p>但是考虑不要使用硬盘分区来构成表空间时，有个很重要的因素： <b>有许多系统备份软件只针对文件系统，不能对硬盘分区进行备份</b> 。这意味着使用硬盘分区来构成表空间将会给系统备份工作增加困难。
</p>
</div>
</div>

</div>

<div id="outline-container-1-14" class="outline-3">
<h3 id="sec-1-14"><span class="section-number-3">1.14</span> 编程接口</h3>
<div class="outline-text-3" id="text-1-14">


</div>

<div id="outline-container-1-14-1" class="outline-4">
<h4 id="sec-1-14-1"><span class="section-number-4">1.14.1</span> 超时重连</h4>
<div class="outline-text-4" id="text-1-14-1">

<p>JDBC连接数据库出现如下问题
</p>
<p class="verse">
Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 99,184,284 milliseconds ago.  The last packet sent successfully to the server was 99,184,284 milliseconds<br/>
&nbsp;&nbsp; ago. is longer than the server configured value of 'wait_timeout'. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts,<br/>
&nbsp;&nbsp; or using the Connector/J connection property 'autoReconnect=true' to avoid this problem.<br/>
</p>


<p>
出现这个问题原因是因为，mysql服务对于长时间不活跃的连接会直接关闭掉，这样client的连接下次操作的时候会出现连接错误。按照上面给出的提示，一个方法是修改wait_timeout，另外一个方法是在JDBC uri里面指定autoReconnect=true这个选项支持自动重连。但是autoReconnect只是对MySQL4以及更老的版本适用，对于MySQL5不适用。接下来看看timeout这个参数。MySQL5手册中对两个变量有如下的说明：
</p><ul>
<li>interactive_timeout：服务器关闭交互式连接前等待活动的秒数。交互式客户端定义为在mysql_real_connect()中使用CLIENT_INTERACTIVE选项的客户端。又见wait_timeout
</li>
<li>wait_timeout:服务器关闭非交互连接之前等待活动的秒数。在线程启动时，根据全局wait_timeout值或全局interactive_timeout值初始化会话wait_timeout值，取决于客户端类型(由mysql_real_connect()的连接选项CLIENT_INTERACTIVE定义)，又见interactive_timeout 
</li>
</ul>

<p>可见wait_timeout只要是用于非交互下面的connection超时时间。可以通过增大这个值然后重启服务来缓解这个问题。
</p>
<p>
但是很明显这个问题治标不治本，最好设想出一个办法可以自动重连。实现自动重连大致无非三种实现：
</p><ul>
<li>每次操作之前检查连接是否OK。这样比较简单，但是有overhead.
</li>
<li>存在单独线程检查连接是否OK。这样overhead比较小，但是实现有点麻烦。
</li>
<li>每次直接执行SQL。如果出现连接错误的话，那么重新连接再次执行SQL。这个方法overhead比较小，同时相对来说也比较简单。
</li>
</ul>


</div>

</div>

<div id="outline-container-1-14-2" class="outline-4">
<h4 id="sec-1-14-2"><span class="section-number-4">1.14.2</span> 连接数量</h4>
<div class="outline-text-4" id="text-1-14-2">

<p>mysql最大连接数目可以通过参数max_connections进行配置，默认的连接数目是比较低的，对于需要处理大量请求的web服务来说需要增大。 <b>修改之后需要重启</b>
</p>



<pre class="example">mysql&gt; show variables like 'max_connections';
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections | 8192  |
+-----------------+-------+
1 row in set (0.00 sec)

mysql&gt; show status like '%connect%'; 
+--------------------------+-------+
| Variable_name            | Value |
+--------------------------+-------+
| Aborted_connects         | 1     |
| Connections              | 6152  |
| Max_used_connections     | 4098  |
| Ssl_client_connects      | 0     |
| Ssl_connect_renegotiates | 0     |
| Ssl_finished_connects    | 0     |
| Threads_connected        | 2050  |
+--------------------------+-------+

7 rows in set (0.00 sec)
</pre>


<p>
对于status状态来说有下面几个和connection相关的数值
</p><ul>
<li>Aborted_connects 尝试已经失败的MySQL服务器的连接的次数。  
</li>
<li>Connections 试图连接MySQL服务器的次数。
</li>
<li>Max_used_connections 同时使用的连接的最大数目。 
</li>
<li>Threads_connected 当前打开的连接的数量。
</li>
</ul>


<p>
修改最大连接数目之后，连接端可能会出现如下错误
</p>


<pre class="example">2013-04-16 19:55:29,772 FATAL com.umeng.dp.umid.UmidHandler: Connection to database failed.
java.sql.SQLException: null,  message from server: "Can't create a new thread (errno 11); if you are not out of available memory, you can consult the manual for a possible OS-dependent bug"
    at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:1074)
    at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:988)
    at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:974)
    at com.mysql.jdbc.MysqlIO.doHandshake(MysqlIO.java:1104)
    at com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2412)
    at com.mysql.jdbc.ConnectionImpl.connectOneTryOnly(ConnectionImpl.java:2445)
    at com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2230)
    at com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:813)
    at com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:47)
    at sun.reflect.GeneratedConstructorAccessor2.newInstance(Unknown Source)
    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:27)
    at java.lang.reflect.Constructor.newInstance(Constructor.java:513)
    at com.mysql.jdbc.Util.handleNewInstance(Util.java:411)
    at com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:399)
    at com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:334)
    at java.sql.DriverManager.getConnection(DriverManager.java:582)
    at java.sql.DriverManager.getConnection(DriverManager.java:185)
    at com.umeng.dp.umid.MysqlConnectionPool.getConnection(MysqlConnectionPool.java:50)
    at com.umeng.dp.umid.DcdiAuthority.getDCDI(DcdiAuthority.java:156)
    at com.umeng.dp.umid.UmidHandler.run(UmidHandler.java:115)
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:439)
    at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
    at java.util.concurrent.FutureTask.run(FutureTask.java:138)
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
    at java.lang.Thread.run(Thread.java:662)
</pre>


<p>
问题还是出在资源限制上面，可以通过修改开辟最大的进程数目来解决。可以参考链接 <a href="http://www.mysqlperformanceblog.com/2013/02/04/cant_create_thread_errno_11/">http://www.mysqlperformanceblog.com/2013/02/04/cant_create_thread_errno_11/</a> 
</p>
</div>
</div>

</div>

<div id="outline-container-1-15" class="outline-3">
<h3 id="sec-1-15"><span class="section-number-3">1.15</span> 实用程序</h3>
<div class="outline-text-3" id="text-1-15">

<ul>
<li>mysql_install_db # 初始化基本表
<ul>
<li>&ndash;usrer=mysql 
</li>
<li>&ndash;datadir=/var/lib/mysql/ 
</li>
<li>权限问题 <a href="http://www.huoxingfan.com/834.html">http://www.huoxingfan.com/834.html</a>
</li>
</ul>

</li>
<li>mysqld # 服务端
</li>
<li>mysql # 客户端
</li>
<li>mysqld_safe # 启动脚本
<ul>
<li>&ndash;skip-grant-tables # 忽略权限表 <b>NOTE（dirlt）：可以用来重置密码</b>
</li>
<li>&ndash;skip-networking # 不启动网络接口
</li>
</ul>

</li>
<li>mysql.server # 启停脚本
<ul>
<li>对mysqld_safe的包装，不接受任何参数
</li>
<li>提供start/stop/restart方法
</li>
</ul>

</li>
<li>mysqld_multi # 启动多个MySQL实例
<ul>
<li>&ndash;defaults_file # Read only this configuration file, do not read the standard system-wide and user-specific files
</li>
<li>&ndash;defaults_extra_file # Read this configuration file in addition to the standard system-wide and user-specific files
</li>
</ul>

</li>
<li>mysqlbinlog # 察看二进制日志文件
</li>
<li>mysqladmin # 系统管理程序，包括关停服务器，检查配置，监控工作状态等
</li>
<li>mysqlcheck # 数据库检查，分析，优化以及对受损数据表进行修复
</li>
<li>mysqldump # 制作数据库文本备份
<ul>
<li>SOURCE file # 导入SQL文件
</li>
</ul>

</li>
</ul>



</div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2014-01-30T14:09+0800</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.2 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
<!-- Baidu Analytics BEGIN --><script type="text/javascript">var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F54a700ad7035f6e485eaf2300641e7e9' type='text/javascript'%3E%3C/script%3E"));</script><!-- Baidu Analytics END --><!-- Google Analytics BEGIN --><!-- <script type="text/javascript">  var _gaq = _gaq || [];  _gaq.push(['_setAccount', 'UA-31377772-1']);  _gaq.push(['_trackPageview']);  (function() {    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);  })();</script> --><!-- Google Analytics END --><!-- Baidu Button BEGIN --><!-- <script type="text/javascript" id="bdshare_js" data="type=tools&amp;uid=6762177" ></script><script type="text/javascript" id="bdshell_js"></script><script type="text/javascript"> document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000)</script> --><!-- Baidu Button END --><!-- G+ BEGIN --><!-- Place this render call where appropriate --><!-- <script type="text/javascript">  (function() {    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;    po.src = 'https://apis.google.com/js/plusone.js';    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);  })();</script> --><!-- G+ END --><!-- DISQUS BEGIN --><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * *//* required: replace example with your forum shortname  */var disqus_shortname = 'dirlt';var disqus_identifier = 'mysql.html';var disqus_title = 'mysql.html';var disqus_url = 'http://dirlt.com/mysql.html';/* * * DON'T EDIT BELOW THIS LINE * * */(function() {var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a><!-- DISQUS END --></body>
</html>
